<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUT Bomb Defusal - Time Locked Hints</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
        }
        .container { max-width: 1400px; margin: 0 auto; width: 100%; }

        /* Header */
        .header {
            text-align: center; padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff0000;
            border-radius: 10px; margin-bottom: 20px;
        }
        .header h1 { color: #ff0000; font-size: 2em; margin-top: 5px; text-shadow: 0 0 10px #ff0000; }
        .timer { font-size: 1.5em; color: #ff0000; font-weight: bold; text-shadow: 0 0 20px #ff0000; }

        /* Layout */
        .stage-flex { display: flex; gap: 20px; align-items: stretch; }
        .left-panel { flex: 1; display: flex; flex-direction: column; min-width: 300px; }
        .right-panel { flex: 1.2; display: flex; flex-direction: column; min-width: 350px; }

        @media (max-width: 900px) {
            .stage-flex { flex-direction: column; }
            .chat-container { height: 500px !important; }
        }

        /* Box Styles */
        .section-box {
            background: rgba(255, 255, 255, 0.05); padding: 20px;
            border-radius: 10px; border-left: 4px solid #00ff00; 
            margin-bottom: 20px;
        }
        
        .story-box {
            background: rgba(255, 255, 0, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffcc00;
            margin-bottom: 20px;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .story-box h3 { color: #ffcc00; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 204, 0, 0.3); padding-bottom: 5px;}

        h2, h3 { color: #00ff00; margin-bottom: 15px; }
        
        .file-section { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; margin-top: 25px; }
        .file-item {
            display: flex; align-items: center; gap: 15px; padding: 12px;
            background: rgba(255, 255, 255, 0.05); border-radius: 5px; margin-bottom: 10px;
            cursor: pointer; transition: all 0.3s;
        }
        .file-item:hover { background: rgba(255, 255, 255, 0.1); border: 1px solid #00ff00; }
        .file-icon { font-size: 28px; }

        .file-item.locked { opacity: 0.5; cursor: not-allowed; border: 1px solid #555; }
        .file-item.locked:hover { background: rgba(255, 255, 255, 0.05); border: 1px solid #555; }

        /* Chat */
        .chat-container {
            background: rgba(0, 0, 0, 0.6); border: 2px solid #00ff00;
            border-radius: 10px; padding: 15px; display: flex; flex-direction: column;
            height: 750px; position: relative; transition: all 0.3s;
        }
        
        .chat-locked-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 10;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-radius: 8px;
        }
        .lock-icon { font-size: 50px; margin-bottom: 10px; }

        .chat-window {
            flex-grow: 1; overflow-y: auto; margin-bottom: 15px; padding-right: 10px;
            border-bottom: 1px solid rgba(0,255,0,0.3);
            scrollbar-width: thin; scrollbar-color: #00ff00 #000;
        }

        .message {
            padding: 12px; margin-bottom: 10px; border-radius: 5px;
            font-size: 0.95em; position: relative;
            width: fit-content; max-width: 85%; display: block;
            word-wrap: break-word; overflow-wrap: break-word; word-break: break-all;
            white-space: pre-wrap; user-select: text; 
        }
        .message.received {
            background: rgba(0, 100, 255, 0.2); border-left: 3px solid #0064ff;
            margin-right: auto; margin-left: 0;
        }
        .message.sent {
            background: rgba(0, 255, 100, 0.2); border-right: 3px solid #00ff64;
            text-align: right; margin-left: auto; margin-right: 0;
        }
        .message-time { font-size: 0.7em; color: #aaa; margin-top: 5px; text-align: right; }

        input[type="text"], input[type="password"] {
            width: 100%; padding: 12px; background: #000;
            border: 1px solid #00ff00; border-radius: 5px;
            color: #00ff00; font-family: 'Courier New', monospace; margin-bottom: 10px;
        }
        button {
            padding: 12px 20px; background: #00ff00; color: #000;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
            font-family: 'Courier New', monospace; transition: all 0.3s; font-size: 1em;
        }
        button:hover { background: #00cc00; transform: translateY(-2px); }
        button:disabled { background: #555; cursor: not-allowed; transform: none; }
        
        /* New Hint Button Style */
        .hint-btn { 
            background: transparent !important; 
            color: #00ff00 !important; 
            border: 1px solid #00ff00 !important; 
            float: right; 
            position: relative;
        }
        
        /* Notification Badge Animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .hint-new-badge {
            position: absolute; top: -5px; right: -5px;
            width: 12px; height: 12px; background: #ff0000;
            border-radius: 50%; display: none;
            animation: pulse-red 1.5s infinite;
        }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9);
            z-index: 2000; align-items: center; justify-content: center; padding: 10px;
        }
        .modal-content {
            background: #1a1a2e; padding: 25px; border-radius: 10px;
            border: 2px solid #00ff00; max-width: 700px; width: 100%;
            max-height: 90vh; overflow-y: auto; word-break: break-all;
        }
        .close-btn { float: right; font-size: 28px; cursor: pointer; color: #ff0000; }
        .key-display {
            background: #000; padding: 15px; border: 1px solid #333;
            color: #0f0; font-size: 0.8em; max-height: 200px; overflow-y: auto;
            word-break: break-all; margin: 10px 0; user-select: text;
        }
        .hidden { display: none; }

        /* --- Hint Box Styles --- */
        .hint-container { display: flex; flex-direction: column; gap: 15px; }
        .hint-box {
            background: #000; border: 1px solid #333; padding: 15px;
            border-radius: 5px; opacity: 0.6; position: relative;
            transition: all 0.5s ease;
        }
        .hint-box.locked { border: 1px dashed #555; }
        .hint-box.unlocked { 
            opacity: 1; border: 1px solid #00ff00; 
            background: rgba(0, 255, 0, 0.05); 
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }
        .hint-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .hint-title { font-weight: bold; color: #aaa; }
        .hint-box.unlocked .hint-title { color: #00ff00; }
        
        .hint-timer-text { color: #ff3333; font-size: 0.9em; font-weight: bold; }
        .hint-content { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); color: #ddd; font-size: 0.9em;}
        .hint-box.unlocked .hint-content { display: block; }
        
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="timer">üö® Phase 1</div>
            <h1 id="timer">02:00:00</h1>
        </div>

        <div id="stage1" class="stage-flex">
            <div class="left-panel">
                
                <div class="story-box">
                    <h3>üìñ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß (Situation)</h3>
                    <p>‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Server ‡∏Ç‡∏≠‡∏á‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢! ‡∏Ñ‡∏ô‡∏£‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ...</p>
                    <br>
                    <p style="color: #fff;">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <b>Private Key</b> ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå <code>secret_key.enc</code> (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏≤‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏Å) ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏°‡∏±‡∏ô‡∏™‡∏ß‡∏°‡∏£‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô User A ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏≠‡∏Å‡∏ñ‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>

                <div class="section-box">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h2>üîê ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (Tools)</h2>
                        <button class="hint-btn" onclick="window.showHint1()">
                            <span id="hintBadge" class="hint-new-badge"></span>
                            üí° ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ
                        </button>
                    </div>

                    <div class="file-section">
                        <h3>üìÅ ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
                        <div class="file-item" onclick="window.openFile('encrypted')">
                            <span class="file-icon">üîí</span>
                            <div>
                                <b>secret_key.enc</b><br>
                                <small style="color:#888;">Private Key (Locked)</small>
                            </div>
                        </div>
                        
                        <div id="btnPublicB" class="file-item locked" onclick="window.openFile('publicB')">
                            <span class="file-icon">üîë</span>
                            <div>
                                <b>public_key_B.pem</b><br>
                                <small style="color:#888;">Key ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (Requires Access)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="chat-container">
                    <div id="chatOverlay" class="chat-locked-overlay">
                        <div class="lock-icon">üîí</div>
                        <h3>Terminal Locked</h3>
                        <p style="color: #aaa;">Please unlock Private Key to connect.</p>
                    </div>

                    <h3 style="border-bottom: 1px solid #00ff00; padding-bottom: 10px; margin-bottom: 10px;">üí¨ Secure Terminal</h3>
                    
                    <div class="chat-window" id="chatWindow"></div>

                    <div>
                        <label style="font-size: 0.8em; color: #00ff00;">Ciphertext:</label>
                        <input type="text" id="messageInput" placeholder="Terminal Offline..." disabled autocomplete="off">
                        <button id="sendBtn" onclick="window.sendMessage()" style="width: 100%;" disabled>üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Send)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="stage2" class="container hidden" style="text-align: center; margin-top: 50px;">
            <div class="section-box" style="border-color: #00ff00; background: rgba(0,255,0,0.1);">
                <h1 style="color: #00ff00; font-size: 2.5em;">üéâ MISSION COMPLETED üéâ</h1>
                <p class="success" style="font-size: 1.5em; margin: 20px 0;">‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
                <div class="key-display" id="nextCode" style="font-size: 1.5em; text-align: center;"></div>
            </div>
        </div>
    </div>

    <div id="encryptedModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="window.closeModal('encryptedModal')">&times;</span>
            <h2>üîí secret_key.enc</h2>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠ Decrypt ‡πÑ‡∏ü‡∏•‡πå:</p>
            <input type="password" id="filePassword" placeholder="Password (4 digits)">
            <button onclick="window.unlockFile()" style="width: 100%;">Unlock</button>
            <div id="fileContent" class="hidden" style="margin-top: 20px;">
                <h3 style="color: #00ff00;">‚úÖ Private Key A</h3>
                <div class="key-display" id="privateKeyA"></div>
                <button onclick="window.copyKey('privateKeyA')" style="width: 100%; margin-top: 10px;">üìã Copy Key</button>
            </div>
        </div>
    </div>

    <div id="publicBModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="window.closeModal('publicBModal')">&times;</span>
            <h2>üîë Public Key B</h2>
            <div class="key-display" id="publicKeyB"></div>
            <button onclick="window.copyKey('publicKeyB')" style="width: 100%;">üìã Copy Key</button>
        </div>
    </div>

    <div id="hintModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="window.closeModal('hintModal')">&times;</span>
            <h2>üí° Hacker's Guide (Time-locked)</h2>
            <p style="color: #888; margin-bottom: 15px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</p>
            
            <div class="hint-container">
                <div id="hintBox1" class="hint-box locked">
                    <div class="hint-header">
                        <span class="hint-title" id="hintTitle1">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 1 (Basic)</span>
                        <span class="hint-timer-text" id="hintTimer1">üîí 10:00</span>
                    </div>
                    <div class="hint-content">
                        <p><b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b> ‡∏Ç‡∏±‡πâ‡∏ô‡πÅ‡∏£‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Private Key ‡∏Å‡πà‡∏≠‡∏ô<br>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå <code>secret_key.enc</code> ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏á‡πà‡∏≤‡∏¢‡πÜ 4 ‡∏ï‡∏±‡∏ß (‡∏•‡∏≠‡∏á 1234 ‡∏î‡∏π‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?)</p>
                    </div>
                </div>

                <div id="hintBox2" class="hint-box locked">
                    <div class="hint-header">
                        <span class="hint-title" id="hintTitle2">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 2 (Decrypt)</span>
                        <span class="hint-timer-text" id="hintTimer2">üîí 20:00</span>
                    </div>
                    <div class="hint-content">
                        <p><b>‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™:</b><br>‡πÄ‡∏°‡∏∑‡πà‡∏≠ Server ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Private Key ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™</p>
                        <code style="display:block; background:#222; padding:5px; margin-top:5px; color:#0f0;">
                            var decrypt = new JSEncrypt();<br>
                            decrypt.setPrivateKey(PRIVATE_KEY_A);<br>
                            var plain = decrypt.decrypt(encryptedMessage);
                        </code>
                    </div>
                </div>

                <div id="hintBox3" class="hint-box locked">
                    <div class="hint-header">
                        <span class="hint-title" id="hintTitle3">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 3 (Encrypt)</span>
                        <span class="hint-timer-text" id="hintTimer3">üîí 30:00</span>
                    </div>
                    <div class="hint-content">
                        <p><b>‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:</b><br>‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ <b>Public Key B</b> ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô Server ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å</p>
                        <code style="display:block; background:#222; padding:5px; margin-top:5px; color:#0f0;">
                            var encrypt = new JSEncrypt();<br>
                            encrypt.setPublicKey(PUBLIC_KEY_B);<br>
                            var cipher = encrypt.encrypt(answer);
                        </code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>

    <script>
    (function() {
        const PRIVATE_KEY_A = `-----BEGIN RSA PRIVATE KEY-----
MIIBVgIBADANBgkqhkiG9w0BAQEFAASCAUAwggE8AgEAAkEA8qYS7EEzj0fUuw8P
07iSiPxYilR7YR/alLsEwGiZMjv5Vd5a9RW71NslIPGtel7LqwCS75a1dc+57XOH
IYv2jwIDAQABAkAsIiiu7+0A0n/Oxh6K07dTUxKHlnYaZEDNbHagyGWUzRkQeJYf
20Inw/G8uXPS6CZGoScZwXCqdRBgWCLAQE0BAiEA/J0qp3wCeuJTQM8OvzheiA2M
rQXhs7m93SR+dIrdtrkCIQD15rZO9BAeLSjY90Xh9y1s4EzGELJgqbwRPktBfCfz
hwIhAJLvOChDUY34p0RDK+i9+P5aI0Fg8m9/0pgW6hcPzvbBAiEA5eb7ghvLyfrc
2uVtT9QCg22+Odw4egmXjOOaBrKmw5cCIQCZmTATaOa9JUxLsuQWvypdQKCSlZVB
dG7knyCM9W2Lsg==
-----END RSA PRIVATE KEY-----`;

        const PUBLIC_KEY_B = `-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAOGPL2PuAOwLPw4mRJUblK4R1hylRimS
Aasz2d+7JEb3Bxi7TT0tXfkSK8czEVWd+9+MwyjHsT+svuUomB/OOBUCAwEAAQ==
-----END PUBLIC KEY-----`;

        const PRIVATE_KEY_B = `-----BEGIN RSA PRIVATE KEY-----
MIIBVQIBADANBgkqhkiG9w0BAQEFAASCAT8wggE7AgEAAkEA4Y8vY+4A7As/DiZE
lRuUrhHWHKVGKZIBqzPZ37skRvcHGLtNPS1d+RIrxzMRVZ3734zDKMexP6y+5SiY
H844FQIDAQABAkAoNaFKHCyX561W9WV2e1M28MENnDz0vi2D+ptVcgQWji89favw
dRm7hPo++wWsP8vB2WR/Sw2NpW6yJqLFNBUhAiEA5zISoqaxnZhjh1pMH+E+wZ9p
SYjLK4SudLddWpiHAMkCIQD5wk74asSKIaWvcrmSFjobsNn+96q6QrIdkycCocuO
7QIgHLDdGSxAnIMdzt1I1yf3xsWGpmaAeB0WHUvoHOcS0ekCIQDKdg8aJUKpTtlG
vlNb7xSvuc8ddps5XjOQ8eafpZSjiQIhAJYomnJ98rOurkrnUARZzAQ8349+3EvX
HsG5mAMr3Jl6
-----END RSA PRIVATE KEY-----`;

        let fileUnlocked = false;
        let chatInterval = null;
        let currentQuestion = null;
        let correctAnswer = null;
        let waitingForAnswer = false;

        // --- Config Hint Times (Seconds) ---
        // 10 mins = 600s, 20 mins = 1200s, 30 mins = 1800s
        // Timer starts at 7200 (2 hours)
        const START_TIME = 7200; 
        const HINT1_TRIGGER = START_TIME - 600;  // unlock at 01:50:00 remaining
        const HINT2_TRIGGER = START_TIME - 1200; // unlock at 01:40:00 remaining
        const HINT3_TRIGGER = START_TIME - 1800; // unlock at 01:30:00 remaining

        let hintsUnlocked = { 1: false, 2: false, 3: false };

        const timerElement = document.getElementById('timer');
        let timeLeft = START_TIME; 

        function updateTimer() {
            timeLeft--; 
            if (timeLeft < 0) timeLeft = 0;
            
            // Format Main Timer
            const h = Math.floor(timeLeft / 3600);
            const m = Math.floor((timeLeft % 3600) / 60);
            const s = timeLeft % 60;
            timerElement.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

            // Check Hints
            checkHintUnlock(1, HINT1_TRIGGER);
            checkHintUnlock(2, HINT2_TRIGGER);
            checkHintUnlock(3, HINT3_TRIGGER);
        }
        setInterval(updateTimer, 1000);

        function checkHintUnlock(boxNum, triggerTime) {
            // Update countdown text inside box if locked
            if (!hintsUnlocked[boxNum]) {
                const secondsUntilUnlock = timeLeft - triggerTime;
                if (secondsUntilUnlock > 0) {
                    const mm = Math.floor(secondsUntilUnlock / 60);
                    const ss = secondsUntilUnlock % 60;
                    document.getElementById(`hintTimer${boxNum}`).textContent = `üîí ‡∏≠‡∏µ‡∏Å ${mm}:${String(ss).padStart(2,'0')}`;
                }
            }

            // Unlock condition
            if (timeLeft <= triggerTime && !hintsUnlocked[boxNum]) {
                unlockHint(boxNum);
            }
        }

        function unlockHint(boxNum) {
            hintsUnlocked[boxNum] = true;
            
            // UI Update
            const box = document.getElementById(`hintBox${boxNum}`);
            box.classList.remove('locked');
            box.classList.add('unlocked');
            
            document.getElementById(`hintTitle${boxNum}`).textContent = `üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${boxNum} (‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß!)`;
            document.getElementById(`hintTimer${boxNum}`).style.display = 'none';

            // Show Notification Badge
            document.getElementById('hintBadge').style.display = 'block';
        }

        // --- Functions ---
        window.openFile = function(type) {
            if (type === 'encrypted') {
                document.getElementById('encryptedModal').style.display = 'flex';
            } else if (type === 'publicB') {
                if (!fileUnlocked) {
                    alert('‚õî ACCESS DENIED: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ Private Key ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô!');
                    return;
                }
                document.getElementById('publicKeyB').textContent = PUBLIC_KEY_B;
                document.getElementById('publicBModal').style.display = 'flex';
            }
        }

        window.closeModal = function(id) { 
            document.getElementById(id).style.display = 'none'; 
            // If hint modal closed, hide badge until new hint comes
            if(id === 'hintModal') {
                // optional: hide badge only if viewed? For now let's keep it simple
            }
        }
        
        window.copyKey = function(id) {
            navigator.clipboard.writeText(document.getElementById(id).textContent).then(() => alert('Copied!'));
        }
        
        window.showHint1 = function() { 
            document.getElementById('hintModal').style.display = 'flex';
            // Clear badge when opened
            document.getElementById('hintBadge').style.display = 'none';
        }

        window.unlockFile = function() {
            const pwd = document.getElementById('filePassword').value;
            if (pwd === '1234') {
                document.getElementById('fileContent').classList.remove('hidden');
                document.getElementById('privateKeyA').textContent = PRIVATE_KEY_A;
                
                fileUnlocked = true;
                
                document.getElementById('btnPublicB').classList.remove('locked');
                document.getElementById('chatOverlay').style.display = 'none';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('messageInput').placeholder = "Ex: U2FsdGVkX1+...";

                addMessage('received', '‡∏£‡∏∞‡∏ö‡∏ö: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à... ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô');
                
                setTimeout(() => {
                    addMessage('received', '‡∏£‡∏∞‡∏ö‡∏ö: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (User A)');
                    setTimeout(sendEncryptedChallenge, 1000);
                }, 1500);

                if(!chatInterval) chatInterval = setInterval(sendEncryptedChallenge, 180000);

            } else {
                alert('‚ùå Password Incorrect');
            }
        }

        // --- Chat Logic ---
        function addMessage(type, text) {
            const chatWindow = document.getElementById('chatWindow');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            const time = new Date().toLocaleTimeString('th-TH');
            div.innerHTML = `<div>${text}</div><div class="message-time">${time}</div>`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function sendEncryptedChallenge() {
            if (!fileUnlocked) return; 

            const n1 = Math.floor(Math.random() * 50) + 10;
            const n2 = Math.floor(Math.random() * 50) + 10;
            correctAnswer = (n1 + n2).toString();
            currentQuestion = `Calculate: ${n1} + ${n2}`;

            const encrypt = new JSEncrypt();
            const PUBLIC_KEY_A_SIM = `-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPKmEuxBM49H1LsPD9O4koj8WIpUe2Ef
2pS7BMBomTI7+VXeWvUVu9TbJSDxrXpey6sAku+WtXXPue1zhyGL9o8CAwEAAQ==
-----END PUBLIC KEY-----`;
            encrypt.setPublicKey(PUBLIC_KEY_A_SIM);
            const encryptedMsg = encrypt.encrypt(currentQuestion);

            addMessage('received', `[ENCRYPTED MESSAGE]\n${encryptedMsg}`);
            waitingForAnswer = true;
        }

        window.sendMessage = function() {
            if (!fileUnlocked) return;
            const input = document.getElementById('messageInput');
            const cipherText = input.value.trim();
            if (!cipherText) return;

            addMessage('sent', cipherText);
            input.value = '';

            setTimeout(() => {
                if (!waitingForAnswer) {
                    addMessage('received', '‡∏£‡∏∞‡∏ö‡∏ö: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà');
                    return;
                }

                const serverDecrypt = new JSEncrypt();
                serverDecrypt.setPrivateKey(PRIVATE_KEY_B);
                const decryptedContent = serverDecrypt.decrypt(cipherText);

                if (decryptedContent === correctAnswer) {
                    addMessage('received', '‚úÖ ACCESS GRANTED: ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
                    clearInterval(chatInterval);
                    setTimeout(sendFinalSecret, 1500);
                } else {
                    addMessage('received', `‚ùå REJECTED: ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ`);
                }
            }, 800);
        }

        function sendFinalSecret() {
            const secret = "SUT-2026-FINAL-KEY";
            const encrypt = new JSEncrypt();
            const PUBLIC_KEY_A_SIM = `-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAPKmEuxBM49H1LsPD9O4koj8WIpUe2Ef
2pS7BMBomTI7+VXeWvUVu9TbJSDxrXpey6sAku+WtXXPue1zhyGL9o8CAwEAAQ==
-----END PUBLIC KEY-----`;
            encrypt.setPublicKey(PUBLIC_KEY_A_SIM);
            const encryptedSecret = encrypt.encrypt(secret);
            
            addMessage('received', `üéâ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏≠:\n${encryptedSecret}`);
            setTimeout(() => {
                const nextCode = "NjIwMi1URVJDRVMtQk1PQi1UVVM=";
                document.getElementById('stage1').classList.add('hidden');
                document.getElementById('stage2').classList.remove('hidden');
                document.getElementById('nextCode').textContent = nextCode;
            }, 5000);
        }
    })();
    </script>
</body>
</html>