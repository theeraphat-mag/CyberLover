<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUT CTF 2026 - Operation: Red Sky RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsotp/2.0.0/jsotp.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Press Start 2P', cursive;
            color: white;
            touch-action: none;
        }

        #game-canvas {
            display: block;
            margin: 0 auto;
            background: #000;
        }

        .hud-panel {
            position: absolute;
            padding: 15px;
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid white;
            z-index: 10;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        #timer-hud { top: 20px; right: 20px; color: #ef4444; font-size: 16px; }
        #mission-hud { top: 20px; left: 20px; font-size: 10px; color: #4ade80; max-width: 300px; line-height: 1.6; }
        
        #phase-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;
            background: #1a1a1a; border: 4px solid #fbbf24;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.8); z-index: 100; padding: 20px; display: none;
        
        }

        #phase-modal::-webkit-scrollbar { width: 10px; }
        #phase-modal::-webkit-scrollbar-track { background: #000; }
        #phase-modal::-webkit-scrollbar-thumb { background: #fbbf24; }

        .btn-military {
            background: #fbbf24; color: black; border: 4px solid white;
            padding: 10px 20px; cursor: pointer; font-family: inherit; margin-top: 10px; width: 100%;
        }
        .btn-military:hover { background: white; transform: scale(1.02); }
        .btn-military:disabled { background: #555; cursor: not-allowed; }
        
        input { width: 100%; background: #000; border: 2px solid #555; color: white; padding: 10px; font-family: inherit; margin-bottom: 10px; }
        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        #victory-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; text-align: center;
            overflow: hidden;
        }

        /* --- Victory Animations --- */
        @keyframes trophy-shake {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-10deg) scale(1.1); }
            50% { transform: rotate(10deg) scale(1.1); }
            75% { transform: rotate(-10deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        #victory-trophy {
            font-size: 100px;
            margin-bottom: 20px;
            animation: trophy-shake 0.8s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.6));
        }

        .confetti {
            position: absolute;
            top: -20px;
            width: 12px;
            height: 12px;
            opacity: 0.9;
            border-radius: 2px;
            z-index: 10; /* Behind text (text is implicitly higher due to flex order but safer to check) */
            pointer-events: none;
            animation: fall linear forwards;
        }

        @keyframes fall {
            to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>

<body class="min-h-screen p-4 md:p-10 flex flex-col items-center">

    <!-- Header & Timer -->
    <header
        class="w-full max-w-5xl flex flex-col md:flex-row justify-between items-center mb-12 border-b border-green-900 pb-6">
        <div>
            <h1 class="text-3xl font-bold tracking-tighter text-white">SUT.BOMB.<span
                    class="text-red-600">PROTOCOL</span></h1>
            <p class="text-[10px] text-green-800 uppercase italic font-bold">Counter-Terrorism Unit | CPE CTF-2026</p>
        </div>
        <div class="mt-4 md:mt-0 text-center">
            <p class="text-[10px] text-red-500 font-bold mb-1 uppercase tracking-widest text-red-500">Time to Detonation
            </p>
            <div id="countdown" class="text-5xl font-bold text-red-600 font-mono">00:01:00</div>
        </div>
    </header>

    <main class="w-full max-w-5xl space-y-12 pb-20">

        <!-- PHASE 1: CRYPTOGRAPHY -->
        <section id="phase1" class="terminal-box p-6 rounded-lg">
            <div class="flex items-center mb-4">
                <span class="w-3 h-3 bg-red-600 rounded-full mr-2 blink"></span>
                <h2 class="text-lg font-bold uppercase">Phase 1: Cryptography - Data Sniffer</h2>
            </div>
            <div
                class="bg-black border border-zinc-900 p-4 rounded text-[10px] h-44 overflow-y-auto mb-6 font-mono text-green-800 leading-relaxed">
                <p>[SYSTEM] Scanning SUT-Internal-WiFi Gateway...</p>
                <p>[TCP] 10.0.0.5:80 -> 10.0.0.99:5412 [ACK, PSH]</p>
                <p class="text-blue-500">[DATA] Sender: "‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡πÅ‡∏•‡πâ‡∏ß"</p>
                <p class="text-blue-400 font-bold">[DATA] Receiver: "‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢
                    (‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß)"</p>
                <p class="text-green-400 font-bold">[ENCODED] Payload: <span id="phase1-encoded"
                        class="bg-green-900/40 text-green-400 select-all p-0.5">LOADING...</span></p>
                <p class="text-yellow-500 mt-2 italic">Hint: ‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Mirror) ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á Base64 Decode</p>
                <p class="text-red-700 mt-2 font-bold blink">[WARNING] ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô Lock 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î
                    OTP</p>
            </div>
            <div class="flex justify-center">
                <button onclick="app.navToPhase2()" class="btn-military px-12 py-3">Access Authentication Panel</button>
            </div>
        </section>

        <!-- PHASE 2: AUTHENTICATION -->
        <section id="phase2"
            class="hidden opacity-0 transform translate-y-4 transition-all duration-700 terminal-box p-6 rounded-lg border-yellow-900">
            <h2 class="text-lg font-bold mb-8 flex items-center text-yellow-500">
                <span class="mr-2">üîê</span> Phase 2: Entity Authentication (3-Locks)
            </h2>

            <div id="lock1-box" class="mb-10 p-6 bg-zinc-950/50 border border-zinc-800 rounded-lg">
                <div class="flex flex-col md:flex-row gap-6 items-center">
                    <div class="text-4xl" id="icon1">üîí</div>
                    <div class="flex-1 w-full">
                        <label class="block text-[10px] text-gray-500 uppercase mb-2">Lock 1: Input Symmetric Key
                            (‡∏à‡∏≤‡∏Å‡∏î‡πà‡∏≤‡∏ô 1)</label>
                        <input type="text" id="lock1-input" placeholder="‡∏ß‡∏≤‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                            class="w-full bg-black border border-zinc-800 p-3 text-sm text-green-400 focus:outline-none focus:border-green-500">
                    </div>
                    <button onclick="app.unlock1()" id="btn-lock1" class="btn-military px-8 py-3">Sync Token</button>
                </div>
            </div>

            <div id="otp-tool"
                class="hidden mb-10 p-6 border border-green-600 bg-green-950/20 rounded-lg flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-[10px] text-green-500 font-bold uppercase tracking-widest mb-1">Squad Handheld Token
                        [SYNCED]</p>
                </div>
                <div class="flex items-center gap-8">
                    <div class="text-right">
                        <div id="live-otp" class="text-4xl font-bold text-white tracking-[0.2em] font-mono">000000</div>
                        <div class="w-full bg-zinc-800 mt-2 h-[2px]">
                            <div id="otp-progress" class="bg-green-500 h-full transition-all duration-1000"
                                style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Lock 2: TOTP -->
                <div id="lock2-card" class="locked lock-card bg-zinc-950 p-6 rounded-lg flex flex-col items-center">
                    <div class="text-3xl mb-4" id="icon2">üîí</div>
                    <p class="text-[10px] text-gray-500 uppercase mb-4 text-center">Lock 2: TOTP (One-Time Password)</p>
                    <input type="text" id="otp-input" maxlength="6" placeholder="------"
                        class="w-full bg-black border border-zinc-800 p-2 text-center text-2xl tracking-[0.3em] text-white focus:outline-none mb-4">
                    <button onclick="app.unlock2()" id="btn-lock2" class="btn-military w-full py-2">Verify OTP</button>
                </div>

                <!-- Lock 3: Location -->
                <div id="lock3-card" class="locked lock-card bg-zinc-950 p-6 rounded-lg flex flex-col items-center">
                    <div class="text-3xl mb-4" id="icon3">üîí</div>
                    <p class="text-[10px] text-gray-500 uppercase mb-4 tracking-widest text-center">Lock 3:
                        Location-based Auth</p>
                    <input type="text" id="loc-input" placeholder="BuildingID+Floor"
                        class="w-full bg-black border border-zinc-800 p-2 text-center text-sm text-white focus:outline-none focus:border-yellow-500 mb-4 uppercase">

                    <div id="loc-hint"
                        class="hidden text-[10px] text-blue-400 text-left w-full mb-4 bg-blue-900/10 p-3 border border-blue-900/30 leading-relaxed">
                        <span class="font-bold underline uppercase text-blue-300">GPS Intel Received:</span><br>
                        "‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà Lat: 14.8704, Long: 102.0209... ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏°‡∏ó‡∏™.
"
                    </div>
                    <button onclick="app.unlock3()" id="btn-lock3" class="btn-military w-full py-2">Verify
                        Location</button>
                </div>
            </div>

            <button id="p3-next" onclick="app.navToPhase3()"
                class="hidden w-full mt-12 py-4 bg-yellow-600 text-black font-bold uppercase text-sm hover:bg-yellow-400 transition-all shadow-lg">
                Enter Disarm Console (Phase 3)
            </button>
        </section>

        <!-- PHASE 3: AUTHORIZATION -->
        <section id="phase3"
            class="hidden opacity-0 transform translate-y-4 transition-all duration-700 terminal-box p-8 rounded-lg border-red-900">
            <h2 class="text-lg font-bold mb-8 text-red-500 flex items-center justify-center">
                <span class="mr-2">‚ö°</span> Phase 3: Authorization - Final Override
            </h2>
            <div id="disarm-panel" class="bg-black border border-zinc-900 p-12 text-center" data-role="user">
                <div class="mb-10">
                    <p class="text-xs text-zinc-600 uppercase mb-2 font-bold">Current Privilege Level:</p>
                    <div id="role-tag"
                        class="inline-block px-8 py-2 border border-red-900 text-red-900 text-xl font-bold uppercase italic tracking-widest">
                        Standard_Guest
                    </div>
                </div>
                <div class="flex justify-center">
                    <button id="disarm-btn" disabled
                        class="px-20 py-6 bg-zinc-900 text-zinc-700 font-bold rounded cursor-not-allowed border border-zinc-800 uppercase tracking-widest text-xl transition-all">
                        Disarm Bomb
                    </button>
                </div>
                <p class="mt-8 text-[10px] text-zinc-700 italic">"Hint: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 'data-role' ‡πÉ‡∏ô Inspect Element ‡πÄ‡∏õ‡πá‡∏ô
                    'admin'"</p>
            </div>
        </section>

        <!-- VICTORY SCREEN -->
        <div id="victory" class="hidden flex flex-col items-center py-20 text-center animate-bounce">
            <div class="text-9xl mb-8">üéñÔ∏è</div>
            <h2 class="text-6xl font-bold text-green-500 mb-4 tracking-tighter uppercase">Mission Clear</h2>
            <p class="text-xl text-green-200 uppercase tracking-widest italic">SUT Is Now Safe From Detonation.</p>
            <div
                class="mt-12 p-8 border-2 border-dashed border-green-500 bg-green-950/20 shadow-[0_0_30px_rgba(0,255,0,0.1)]">
                <p class="text-xs text-green-700 uppercase mb-2 font-bold">Operation Flag:</p>
                <code class="text-4xl font-bold text-white tracking-widest">SUT{CPE_CTF_2026_BOMB_HERO}</code>
            </div>
        </div>

        <!-- DETONATION SCREEN -->
        <div id="detonated" class="hidden flex flex-col items-center py-20 text-center">
            <div class="text-9xl mb-8">üí•</div>
            <h2 class="text-6xl font-bold text-red-600 mb-4 tracking-tighter uppercase">Mission Failed</h2>
            <p class="text-xl text-red-400 uppercase tracking-widest italic">Bomb Detonated. Time Window Expired.</p>
            <div
                class="mt-12 p-8 border-2 border-dashed border-red-600 bg-red-950/20 shadow-[0_0_30px_rgba(255,0,0,0.15)]">
                <p class="text-xs text-red-500 uppercase mb-2 font-bold">Status:</p>
                <code class="text-4xl font-bold text-white tracking-widest">SUT{CPE_CTF_2026_TIMEOUT}</code>
            </div>
        </div>
    </main>

    <div id="modal" class="hidden fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4">
        <div class="bg-zinc-950 border border-green-500 p-8 max-w-sm w-full text-center shadow-2xl terminal-box">
            <p id="modal-msg" class="text-green-500 font-bold mb-8 leading-relaxed"></p>
            <button onclick="app.closeModal()"
                class="w-full py-3 bg-green-700 text-black font-bold uppercase hover:bg-green-400 transition-all">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
        </div>
        <div style="margin-top:10px; font-size:8px; color:#aaa;">[WASD] Move | [SHIFT] Sprint</div>
    </div>
    
    <div id="timer-hud" class="hud-panel" style="display:none;">
        TIME: <span id="timer-display">02:00:00</span>
    </div>

    <div id="start-screen" style="position:fixed; inset:0; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
        <h1 style="color: #fbbf24; font-size: 3rem; margin-bottom: 20px; text-shadow: 0 0 20px #fbbf24;">OPERATION:<br>RED SKY</h1>
        <p style="color: #aaa; margin-bottom: 40px; font-size: 0.8rem;">SUT CTF RPG 2026</p>
        <button id="start-btn" class="btn-military" style="width: 200px; font-size: 1.2rem;">START MISSION</button>
    </div>

    <canvas id="game-canvas" style="display:none;"></canvas>

    <div id="phase-modal">
        <div id="modal-content"></div>
        <!-- <span class="close-btn" onclick="window.game.closeModal()">&times;</span>  ‡πÄ‡∏≠‡∏≤ x ‡∏≠‡∏≠‡∏Å--> 
    </div>

    <div id="victory-screen">
        <div id="victory-trophy">üèÜ</div>
        <h1 style="color: #4ade80; margin: 20px 0; z-index: 20; position: relative;">MISSION COMPLETE</h1>
        <p style="color: white; line-height: 2; z-index: 20; position: relative;">SUT IS SAFE.<br>FLAG: <span style="color:#fbbf24">SUT{CPE_RPG_HERO_2026}</span></p>
        <button onclick="location.reload()" class="btn-military" style="width: 200px; margin-top: 30px; z-index: 20; position: relative;">PLAY AGAIN</button>
    </div>

    <video id="intro-video" style="display:none; position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:300; background:black;">
        <source src="bomb.mp4" type="video/mp4">
    </video>

    <video id="hero-video" style="display:none; position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:300; background:black;">
        <source src="hero.mp4" type="video/mp4">
    </video>

    <script src="game_logic.js"></script>

    <script>
        const app = {
            config: {
                symmetricKey: "SUT-BOMB-SECRET-2026",
                otpSeed: "JBSWY3DPEHPK3PXP", // Base32 Standard
                locationAnswer: [
                    "‡∏´‡∏≠‡πÅ‡∏´‡πâ‡∏ß",
                    "‡∏´‡∏≠‡∏™‡∏∏‡∏£‡∏ô‡∏†‡∏≤",
                    "HORHAEW",
                    "HOR HAEW",
                    "HORHAEW DORMITORY",
                    "HORSURANAPA"
                ]
            },
            timeLeft: 2 * 60 * 60,
            otpInterval: null,

            currentOTP: null,
            currentTimeSlot: null,

            init: function () {
                this.startTimer();
                this.setupAuthorizationObserver();
                this.injectPhase1Encoded();
            },

            startTimer: function () {
                const display = document.getElementById('countdown');
                this.timerInterval = setInterval(() => {
                    if (this.timeLeft <= 0) {
                        clearInterval(this.timerInterval);
                        this.detonate();
                        return;
                    }
                    this.timeLeft--;
                    const h = Math.floor(this.timeLeft / 3600).toString().padStart(2, '0');
                    const m = Math.floor((this.timeLeft % 3600) / 60).toString().padStart(2, '0');
                    const s = (this.timeLeft % 60).toString().padStart(2, '0');
                    display.innerText = `${h}:${m}:${s}`;
                }, 1000);
            },

            showModal: function (msg) {
                document.getElementById('modal-msg').innerText = msg;
                document.getElementById('modal').classList.remove('hidden');
            },
            closeModal: function () { document.getElementById('modal').classList.add('hidden'); },

            navToPhase2: function () {
                const p2 = document.getElementById('phase2');
                p2.classList.remove('hidden');
                setTimeout(() => { p2.classList.replace('opacity-0', 'opacity-100'); p2.classList.replace('translate-y-4', 'translate-y-0'); }, 100);
                window.scrollTo({ top: p2.offsetTop - 50, behavior: 'smooth' });
            },

            unlock1: function () {
                const val = document.getElementById('lock1-input').value.trim();
                if (val === this.config.symmetricKey) {
                    document.getElementById('icon1').innerText = "üîì";
                    document.getElementById('lock1-box').classList.add('border-green-500');
                    document.getElementById('otp-tool').classList.remove('hidden');

                    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ locked ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° unlocked
                    const card2 = document.getElementById('lock2-card');
                    card2.classList.remove('locked');
                    card2.classList.add('unlocked');

                    this.startOTPGeneration();
                    this.showModal("UNLOCK 1 SUCCESS: ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏´‡∏±‡∏™ OTP...");
                } else { this.showModal("ERROR: ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
            },

            startOTPGeneration: function () {
                if (this.otpInterval) clearInterval(this.otpInterval);

                this.otpInterval = setInterval(() => {
                    const now = Math.floor(Date.now() / 1000);
                    const timeSlot = Math.floor(now / 60);

                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏™‡∏∏‡πà‡∏° OTP ‡πÉ‡∏´‡∏°‡πà
                    if (this.currentTimeSlot !== timeSlot) {
                        this.currentTimeSlot = timeSlot;
                        this.currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
                    }

                    document.getElementById('live-otp').innerText = this.currentOTP;

                    const progress = ((60 - (now % 60)) / 60) * 100;
                    document.getElementById('otp-progress').style.width = progress + "%";
                }, 1000);
            },




            unlock2: function () {
                const input = document.getElementById('otp-input').value.trim();

                if (input === this.currentOTP) {
                    document.getElementById('icon2').innerText = "üîì";

                    //  ‡∏´‡∏¢‡∏∏‡∏î OTP ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    clearInterval(this.otpInterval);
                    this.otpInterval = null;

                    // ‡∏•‡πá‡∏≠‡∏Å progress bar ‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡πà‡∏á
                    document.getElementById('otp-progress').style.width = "0%";

                    const card3 = document.getElementById('lock3-card');
                    card3.classList.remove('locked');
                    card3.classList.add('unlocked');

                    document.getElementById('loc-hint').classList.remove('hidden');
                    this.showModal("UNLOCK 2 SUCCESS: OTP ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Token ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß)");
                } else {
                    this.showModal("ERROR: ‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            },




            unlock3: function () {
                const val = document.getElementById('loc-input')
                    .value.trim()
                    .toUpperCase();

                const answers = this.config.locationAnswer.map(a => a.toUpperCase());

                if (answers.includes(val)) {
                    document.getElementById('icon3').innerText = "üîì";
                    document.getElementById('p3-next').classList.remove('hidden');
                    this.showModal("UNLOCK 3 SUCCESS: Location verified");
                } else {
                    this.showModal("ERROR: Location token mismatch");
                }
            },



            navToPhase3: function () {
                const p3 = document.getElementById('phase3');
                p3.classList.remove('hidden');
                setTimeout(() => { p3.classList.replace('opacity-0', 'opacity-100'); p3.classList.replace('translate-y-4', 'translate-y-0'); }, 100);
                window.scrollTo({ top: p3.offsetTop - 50, behavior: 'smooth' });
            },

            setupAuthorizationObserver: function () {
                const panel = document.getElementById('disarm-panel');
                const observer = new MutationObserver(() => {
                    if (panel.getAttribute('data-role') === "admin") {
                        this.activateAdminPrivilege();
                    }
                });
                observer.observe(panel, { attributes: true });
            },

            activateAdminPrivilege: function () {
                const roleTag = document.getElementById('role-tag');
                const disarmBtn = document.getElementById('disarm-btn');
                roleTag.innerText = "System_Administrator";
                roleTag.classList.replace('text-red-900', 'text-green-500');
                roleTag.classList.replace('border-red-900', 'border-green-500');
                disarmBtn.disabled = false;
                disarmBtn.classList.replace('bg-zinc-900', 'bg-red-600');
                disarmBtn.classList.replace('text-zinc-700', 'text-white');
                disarmBtn.classList.replace('cursor-not-allowed', 'cursor-pointer');
                disarmBtn.onclick = () => {
                    document.querySelectorAll('section, header, #otp-tool').forEach(s => s.classList.add('hidden'));
                    document.getElementById('victory').classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
            }
            ,

            detonate: function () {
                // Stop OTP updates if running
                if (this.otpInterval) {
                    clearInterval(this.otpInterval);
                    this.otpInterval = null;
                }

                // Hide interactive UI and show detonation screen
                document.querySelectorAll('section, header, #otp-tool').forEach(s => s.classList.add('hidden'));
                document.getElementById('detonated').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            ,

            injectPhase1Encoded: function () {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™: Reverse ‡πÅ‡∏•‡πâ‡∏ß Base64
                const reversed = this.config.symmetricKey.split('').reverse().join('');
                const encoded = btoa(reversed);
                const el = document.getElementById('phase1-encoded');
                if (el) el.innerText = encoded;
            }
        };

        let startGame;
        window.onload = () => {
            // Aggressive Zoom Prevention
            const preventZoom = (e) => {
                if (e.ctrlKey || e.scale !== undefined && e.scale !== 1) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                }
            };

            window.addEventListener('keydown', e => {
                if (e.ctrlKey && ['=', '-', '+', '0'].includes(e.key)) e.preventDefault();
            });


            window.addEventListener('wheel', preventZoom, { passive: false });
            window.addEventListener('gesturestart', preventZoom, { passive: false });
            window.addEventListener('gesturechange', preventZoom, { passive: false });
            window.addEventListener('gestureend', preventZoom, { passive: false });

            function startGame() {
                const introVideo = document.getElementById('intro-video');
                if (introVideo) {
                    introVideo.pause();
                    introVideo.style.display = 'none';
                    introVideo.onended = null;
                    introVideo.onclick = null;
                }
                document.getElementById('game-canvas').style.display = 'block';
                document.getElementById('mission-hud').style.display = 'block';
                document.getElementById('timer-hud').style.display = 'block';
                if (typeof game !== 'undefined' && game.init) {
                    game.init();
                }
            }
        
            // Start Button Logic
            document.getElementById('start-btn').addEventListener('click', () => {
                const introVideo = document.getElementById('intro-video');
                const startScreen = document.getElementById('start-screen');
                
                startScreen.style.display = 'none';
                introVideo.style.display = 'block';
                
                introVideo.play().catch(error => {
                    console.error("Video play failed:", error);
                    startGame();
                });

                introVideo.onended = () => {
                    startGame();
                };

                // Allow skipping with a click
                introVideo.onclick = () => {
                    startGame();
                };

                
            });
        };
    </script>
</body>
</html>