<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUT CTF 2026 - Operation: Red Sky RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsotp/2.0.0/jsotp.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Press Start 2P', cursive;
            color: white;
            touch-action: none; /* Prevent touch zoom gestures */
        }

        #game-canvas {
            display: block;
            margin: 0 auto;
            background: #000;
        }

        /* UI Overlays */
        .hud-panel {
            position: absolute;
            padding: 15px;
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid white;
            z-index: 10;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        #timer-hud {
            top: 20px; right: 20px;
            color: #ef4444;
            font-size: 16px;
        }

        #mission-hud {
            top: 20px; left: 20px;
            font-size: 10px;
            color: #4ade80;
            max-width: 300px;
            line-height: 1.6;
        }
        
        /* Modal for Phases */
        #phase-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            background: #1a1a1a;
            border: 4px solid #fbbf24;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.8);
            z-index: 100;
            padding: 20px;
            display: none; /* Hidden by default */
        }

        /* Custom Scrollbar for Modal */
        #phase-modal::-webkit-scrollbar { width: 10px; }
        #phase-modal::-webkit-scrollbar-track { background: #000; }
        #phase-modal::-webkit-scrollbar-thumb { background: #fbbf24; }

        /* Styles reused from previous phases but adapted */
        .terminal-box { border: none; background: transparent; }
        .btn-military {
            background: #fbbf24; color: black; border: 4px solid white;
            padding: 10px 20px; cursor: pointer; font-family: inherit;
            margin-top: 10px; width: 100%;
        }
        .btn-military:hover { background: white; transform: scale(1.02); }
        .btn-military:disabled { background: #555; cursor: not-allowed; }
        
        input {
            width: 100%; background: #000; border: 2px solid #555;
            color: white; padding: 10px; font-family: inherit; margin-bottom: 10px;
        }

        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Victory Screen */
        #victory-screen {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- HUD -->
    <div id="mission-hud" class="hud-panel">
        <h3 style="color:#fbbf24; margin-bottom:10px;">MISSION OBJECTIVE</h3>
        <p id="objective-text">Go to the SUT Farm (WIFI Tower) to intercept the signal.</p>
        <div style="margin-top:10px; font-size:8px; color:#aaa;">[WASD] Move | [SHIFT] Sprint</div>
    </div>
    
    <div id="timer-hud" class="hud-panel">
        TIME: <span id="timer-display">02:00:00</span>
    </div>

    <!-- GAME CANVAS -->
    <canvas id="game-canvas"></canvas>

    <!-- PHASE MODAL CONTAINER -->
    <div id="phase-modal">
        <!-- Dynamic Content Loads Here -->
        <div id="modal-content"></div>
        <button id="close-modal-btn" class="hidden mt-4 text-xs text-red-500 underline" onclick="game.closeModal()">[FORCE CLOSE - DEBUG]</button>
    </div>

    <!-- VICTORY OVERLAY -->
    <div id="victory-screen">
        <div style="font-size: 80px;">üèÜ</div>
        <h1 style="color: #4ade80; margin: 20px 0;">MISSION COMPLETE</h1>
        <p style="color: white; line-height: 2;">
            SUT IS SAFE.<br>
            FLAG: <span style="color:#fbbf24">SUT{CPE_RPG_HERO_2026}</span>
        </p>
        <button onclick="location.reload()" class="btn-military" style="width: 200px; margin-top: 30px;">PLAY AGAIN</button>
    </div>

    <script>
        /**
         * SUT CTF RPG ENGINE v4.1 (Cleaned & Dynamic)
         */
        const game = {
            canvas: document.getElementById('game-canvas'),
            ctx: null,
            width: 800,
            height: 600,
            
            state: 'playing',
            level: 1,
            
            // Assets
            mapImage: new Image(),
            playerSprite: new Image(),
            assetsLoaded: 0,

            // World Dimensions (Set dynamically via map image)
            worldWidth: 0, 
            worldHeight: 0,

            // Camera
            camera: { x: 0, y: 0 },

            // Entities
            player: { 
                x: 0, y: 0, 
                width: 48, height: 64, 
                speed: 8, 
                frameX: 0, frameY: 0, 
                moving: false, 
                direction: 0,
                hitbox: { x: 0, y: 0, w: 32, h: 20, offsetX: 8, offsetY: 44 }
            },
            
            // Collision
            obstacles: [],
            editor: { active: false, isDragging: false, startX: 0, startY: 0, currentRect: null },
            
            // DEBUG SYSTEM
            debugMode: false,
            mousePos: { x: 0, y: 0 },

            checkpoints: [
                { id: 1, x: 0, y: 0, width: 120, height: 120, color: '#ef4444', active: true, label: 'SUT FARM', icon: 'üåª' },
                { id: 2, x: 0, y: 0, width: 120, height: 120, color: '#fbbf24', active: false, label: 'DORMS', icon: 'üè†' },
                { id: 3, x: 0, y: 0, width: 150, height: 150, color: '#a855f7', active: false, label: 'F10 ADMIN', icon: 'üè´' }
            ],

            config: {
                symmetricKey: "SUT-BOMB-SECRET-2026",
                otpSeed: "JBSWY3DPEHPK3PXP",
                locationCode: "F109"
            },
            timeLeft: 7200,
            timerInterval: null,
            otpInterval: null,
            currentOTP: null,

            init: function() {
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                this.keys = {};
                window.addEventListener('keydown', e => {
                    this.keys[e.key] = true;
                    if (e.key.toLowerCase() === 'm') this.toggleEditor();
                    if (e.key.toLowerCase() === 'o') this.debugMode = !this.debugMode; // Toggle Debug
                    if (e.key.toLowerCase() === 'z' && this.editor.active) this.obstacles.pop();
                    if (e.key.toLowerCase() === 'p') this.exportObstacles();
                });
                window.addEventListener('keyup', e => this.keys[e.key] = false);

                this.canvas.addEventListener('mousedown', e => this.handleMouseDown(e));
                this.canvas.addEventListener('mousemove', e => {
                    this.handleMouseMove(e);
                    // Update Mouse Pos for Debug
                    const rect = this.canvas.getBoundingClientRect();
                    this.mousePos.x = Math.round((e.clientX - rect.left) + this.camera.x);
                    this.mousePos.y = Math.round((e.clientY - rect.top) + this.camera.y);
                });
                this.canvas.addEventListener('mouseup', e => this.handleMouseUp(e));

                // Load Assets
                this.mapImage.src = 'sut_map.png'; 
                this.playerSprite.src = 'https://i.imgur.com/f2a1p7I.png'; 
                
                this.mapImage.onload = () => {
                    this.assetsLoaded++;
                    this.worldWidth = this.mapImage.naturalWidth;
                    this.worldHeight = this.mapImage.naturalHeight;
                    
                    // Position entities based on map scale
                    this.player.x = this.worldWidth * 0.9;
                    this.player.y = this.worldHeight * 0.1;
                    this.checkpoints[0].x = this.worldWidth * 0.15;
                    this.checkpoints[0].y = this.worldHeight * 0.8;
                    this.checkpoints[1].x = this.worldWidth * 0.2;
                    this.checkpoints[1].y = this.worldHeight * 0.2;
                    this.checkpoints[2].x = this.worldWidth * 0.5;
                    this.checkpoints[2].y = this.worldHeight * 0.5;
                };
                
                this.playerSprite.onload = () => this.assetsLoaded++;

                this.startTimer();
                this.gameLoop();
            },            // --- EDITOR LOGIC ---
            saveWalls: function() {
                localStorage.setItem('sut_rpg_walls', JSON.stringify(this.obstacles));
            },

            toggleEditor: function() {
                this.editor.active = !this.editor.active;
                const hud = document.getElementById('mission-hud');
                if(this.editor.active) {
                    hud.innerHTML = `<h3 style="color:red">üöß MAP BUILDER MODE üöß</h3>
                    <p style="color:white">Draw RED BOXES over buildings/grass to block them.</p>
                    <hr style="border-color:#555; margin:5px 0;">
                    <p>[Click+Drag] Create Wall</p>
                    <p>[Z] Undo Last | [X] Clear All</p>
                    <p>[M] Save & Exit</p>`;
                } else {
                    hud.innerHTML = `<h3 style="color:#fbbf24">MISSION OBJECTIVE</h3>
                    <p id="objective-text">Go to the SUT Farm (WIFI Tower) to intercept the signal.</p>
                    <div style="margin-top:10px; font-size:8px; color:#aaa;">[WASD] Move | [SHIFT] Sprint | [M] Edit Map</div>`;
                }
            },

            getMousePos: function(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left) + this.camera.x,
                    y: (e.clientY - rect.top) + this.camera.y
                };
            },

            handleMouseDown: function(e) {
                if (!this.editor.active) return;
                this.editor.isDragging = true;
                const pos = this.getMousePos(e);
                this.editor.startX = pos.x;
                this.editor.startY = pos.y;
                this.editor.currentRect = { x: pos.x, y: pos.y, w: 0, h: 0 };
            },

            handleMouseMove: function(e) {
                if (!this.editor.active || !this.editor.isDragging) return;
                const pos = this.getMousePos(e);
                this.editor.currentRect.w = pos.x - this.editor.startX;
                this.editor.currentRect.h = pos.y - this.editor.startY;
            },

            handleMouseUp: function(e) {
                if (!this.editor.active || !this.editor.isDragging) return;
                this.editor.isDragging = false;
                
                let r = this.editor.currentRect;
                if (r.w < 0) { r.x += r.w; r.w = Math.abs(r.w); }
                if (r.h < 0) { r.y += r.h; r.h = Math.abs(r.h); }
                
                if (r.w > 10 && r.h > 10) {
                    this.obstacles.push(r);
                    this.saveWalls(); // Save after adding
                }
                this.editor.currentRect = null;
            },

            exportObstacles: function() {
                console.log("--- COPY THE LINES BELOW ---");
                console.log(`game.obstacles = ${JSON.stringify(this.obstacles)};`);
                console.log("----------------------------");
                alert("Obstacle data printed to Console (F12)!");
            },

            // --- GAME LOOP ---
            resize: function() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            startTimer: function() {
                this.timerInterval = setInterval(() => {
                    if (this.state !== 'playing' && this.state !== 'paused') return;
                    if (this.timeLeft <= 0) {
                        this.gameOver();
                        return;
                    }
                    this.timeLeft--;
                    const h = Math.floor(this.timeLeft / 3600).toString().padStart(2, '0');
                    const m = Math.floor((this.timeLeft % 3600) / 60).toString().padStart(2, '0');
                    const s = (this.timeLeft % 60).toString().padStart(2, '0');
                    document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
                }, 1000);
            },

            update: function() {
                if (this.state !== 'playing') return;

                this.player.moving = false;
                let dx = 0;
                let dy = 0;

                if (this.keys['ArrowUp'] || this.keys['w']) { dy = -this.player.speed; this.player.direction = 3; this.player.moving = true; }
                if (this.keys['ArrowDown'] || this.keys['s']) { dy = this.player.speed; this.player.direction = 0; this.player.moving = true; }
                if (this.keys['ArrowLeft'] || this.keys['a']) { dx = -this.player.speed; this.player.direction = 1; this.player.moving = true; }
                if (this.keys['ArrowRight'] || this.keys['d']) { dx = this.player.speed; this.player.direction = 2; this.player.moving = true; }

                // Move Player
                this.player.x += dx;
                this.player.y += dy;

                // World Boundaries
                if(this.player.x < 0) this.player.x = 0;
                if(this.player.y < 0) this.player.y = 0;
                if(this.player.x > this.worldWidth - this.player.width) this.player.x = this.worldWidth - this.player.width;
                if(this.player.y > this.worldHeight - this.player.height) this.player.y = this.worldHeight - this.player.height;

                // Update Camera (Center on player)
                this.camera.x = this.player.x - this.canvas.width / 2;
                this.camera.y = this.player.y - this.canvas.height / 2;

                // Clamp Camera
                if(this.camera.x < 0) this.camera.x = 0;
                if(this.camera.y < 0) this.camera.y = 0;
                if(this.camera.x > this.worldWidth - this.canvas.width) this.camera.x = this.worldWidth - this.canvas.width;
                if(this.camera.y > this.worldHeight - this.canvas.height) this.camera.y = this.worldHeight - this.canvas.height;

                // Animation Frame
                if (this.player.moving) {
                    // Simple 4-frame animation loop
                    if (Date.now() % 200 < 50) this.player.frameX = 0;
                    else if (Date.now() % 200 < 100) this.player.frameX = 1;
                    else if (Date.now() % 200 < 150) this.player.frameX = 2;
                    else this.player.frameX = 3;
                } else {
                    this.player.frameX = 0; // Idle
                }

                // Checkpoint Collision
                this.checkpoints.forEach(cp => {
                    if (!cp.active) return;
                    if (this.checkCollision(this.player, cp)) {
                        this.triggerPhase(cp.id);
                    }
                });
            },

            draw: function() {
                // Clear Canvas
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.save();
                this.ctx.translate(-this.camera.x, -this.camera.y);

                // 1. Draw Map Image (Background)
                if (this.assetsLoaded >= 1 && this.mapImage.naturalWidth > 0) {
                    this.ctx.drawImage(this.mapImage, 0, 0, this.worldWidth, this.worldHeight);
                } else {
                    // Fallback Text while loading
                    this.ctx.fillStyle = '#1a1a1a';
                    this.ctx.fillRect(0, 0, this.worldWidth || 800, this.worldHeight || 600);
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '20px Arial';
                    this.ctx.fillText("LOADING MAP...", (this.worldWidth||800)/2, (this.worldHeight||600)/2);
                }

                // 2. Draw Checkpoints (Debug Mode Only)
                if (this.debugMode) {
                    this.checkpoints.forEach(cp => {
                        this.ctx.lineWidth = 2;
                        this.ctx.strokeStyle = cp.active ? '#00ff00' : '#ffff00';
                        this.ctx.strokeRect(cp.x, cp.y, cp.width, cp.height);
                        
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = '12px Arial';
                        this.ctx.fillText(`ID:${cp.id} (${Math.round(cp.x)},${Math.round(cp.y)})`, cp.x, cp.y - 5);
                    });
                }

                // 3. Draw Editor Obstacles (Only if Editor is Active)
                if (this.editor.active) {
                    this.ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                    this.ctx.strokeStyle = 'red';
                    this.ctx.lineWidth = 2;
                    
                    this.obstacles.forEach(wall => {
                        this.ctx.fillRect(wall.x, wall.y, wall.w, wall.h);
                        this.ctx.strokeRect(wall.x, wall.y, wall.w, wall.h);
                    });

                    // Current drawing rect
                    if (this.editor.currentRect) {
                        this.ctx.fillStyle = 'rgba(255, 255, 0, 0.5)';
                        this.ctx.fillRect(this.editor.currentRect.x, this.editor.currentRect.y, this.editor.currentRect.w, this.editor.currentRect.h);
                    }
                }

                // 4. Draw Player
                if (this.assetsLoaded >= 2) {
                    const spriteW = this.playerSprite.width / 4;
                    const spriteH = this.playerSprite.height / 4;
                    
                    this.ctx.drawImage(
                        this.playerSprite,
                        this.player.frameX * spriteW, this.player.direction * spriteH, 
                        spriteW, spriteH, 
                        this.player.x, this.player.y, 
                        this.player.width, this.player.height 
                    );
                } else {
                    // Fallback Player Box
                    this.ctx.fillStyle = '#00f2ff';
                    this.ctx.fillRect(this.player.x, this.player.y, this.player.width, this.player.height);
                }

                this.ctx.restore();

                // 5. Draw Debug Mouse Coordinates (UI Layer - Not affected by Camera)
                if (this.debugMode) {
                    this.ctx.fillStyle = 'rgba(0,0,0,0.7)';
                    this.ctx.fillRect(10, 100, 200, 40);
                    this.ctx.fillStyle = '#00ff00';
                    this.ctx.font = '14px Arial';
                    this.ctx.fillText(`MOUSE: X=${this.mousePos.x}, Y=${this.mousePos.y}`, 20, 125);
                }
            },

            gameLoop: function() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.gameLoop());
            },

            checkCollision: function(rect1, rect2) {
                return (rect1.x < rect2.x + rect2.width &&
                        rect1.x + rect1.width > rect2.x &&
                        rect1.y < rect2.y + rect2.height &&
                        rect1.y + rect1.height > rect2.y);
            },

            // --- PHASE HANDLING ---
            triggerPhase: function(id) {
                if (id !== this.level) return;
                
                this.state = 'paused';
                const modal = document.getElementById('phase-modal');
                const content = document.getElementById('modal-content');
                modal.style.display = 'block';
                
                const path = `phases/phase${id}.html`;
                fetch(path)
                    .then(r => r.text())
                    .then(html => {
                        content.innerHTML = html;
                        this.attachPhaseLogic(id);
                    });
            },

            closeModal: function() {
                document.getElementById('phase-modal').style.display = 'none';
                this.state = 'playing';
            },

            completeLevel: function() {
                this.closeModal();
                this.checkpoints[this.level - 1].active = false;
                this.checkpoints[this.level - 1].color = '#22c55e';
                this.checkpoints[this.level - 1].icon = '‚úÖ';

                this.level++;
                
                if (this.level <= this.checkpoints.length) {
                    this.checkpoints[this.level - 1].active = true;
                    // Move slightly to avoid re-trigger
                    if(this.level === 2) this.player.x = 1000; // Reset to road for next point
                    if(this.level === 3) this.player.x = 1000;

                    const objectives = [
                        "",
                        "Objective: Go to SUT Dormitories (Gate) to authenticate.",
                        "Objective: Rush to Building F10 (Core) to disarm!"
                    ];
                    document.getElementById('objective-text').innerText = objectives[this.level - 1];
                } else {
                    this.victory();
                }
            },

            gameOver: function() {
                this.state = 'gameover';
                document.body.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100vh; background:black; color:red; flex-direction:column;">
                    <h1 style="font-size:4rem;">GAME OVER</h1>
                    <p>THE SCHOOL HAS FALLEN.</p>
                    <button onclick="location.reload()" style="margin-top:20px; padding:10px;">RETRY</button>
                </div>`;
            },

            victory: function() {
                this.state = 'victory';
                document.getElementById('victory-screen').style.display = 'flex';
                clearInterval(this.timerInterval);
            },

            attachPhaseLogic: function(levelId) {
                window.app = {
                    navToPhase2: () => { this.completeLevel(); },
                    unlock1: () => {
                        const val = document.getElementById('lock1-input').value.trim();
                        if (val === this.config.symmetricKey) {
                            document.getElementById('icon1').innerText = "üîì";
                            document.getElementById('lock1-box').classList.add('border-green-500');
                            document.getElementById('otp-tool').classList.remove('hidden');
                            
                            const card2 = document.getElementById('lock2-card');
                            card2.classList.remove('locked');
                            card2.classList.add('unlocked');
                            
                            this.startOTPGeneration();
                        } else { alert("WRONG KEY"); }
                    },
                    unlock2: () => {
                        const input = document.getElementById('otp-input').value.trim();
                        if (input === this.currentOTP) {
                             document.getElementById('icon2').innerText = "üîì";
                             clearInterval(this.otpInterval);
                             const card3 = document.getElementById('lock3-card');
                             card3.classList.remove('locked');
                             card3.classList.add('unlocked');
                             document.getElementById('loc-hint').classList.remove('hidden');
                        } else { alert("WRONG OTP"); }
                    },
                    unlock3: () => {
                        const val = document.getElementById('loc-input').value.trim().toUpperCase();
                        if (val === this.config.locationCode) {
                            document.getElementById('icon3').innerText = "üîì";
                            document.getElementById('p3-next').classList.remove('hidden');
                        } else { alert("WRONG LOCATION"); }
                    },
                    navToPhase3: () => { this.completeLevel(); }
                };
                
                if (levelId === 3) {
                     const panel = document.getElementById('disarm-panel');
                     const observer = new MutationObserver(() => {
                        if (panel.getAttribute('data-role') === "admin") {
                            this.completeLevel();
                        }
                    });
                    observer.observe(panel, { attributes: true });
                }
            },

            startOTPGeneration: function() {
                if(this.otpInterval) clearInterval(this.otpInterval);
                this.otpInterval = setInterval(() => {
                    const now = Math.floor(Date.now() / 1000);
                    const timeSlot = Math.floor(now / 60);
                    if (this.currentTimeSlot !== timeSlot) {
                        this.currentTimeSlot = timeSlot;
                        this.currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
                    }
                    const display = document.getElementById('live-otp');
                    const bar = document.getElementById('otp-progress');
                    if(display) display.innerText = this.currentOTP;
                    if(bar) {
                        const progress = ((60 - (now % 60)) / 60) * 100;
                        bar.style.width = progress + "%";
                    }
                }, 1000);
            }
        };

        window.onload = () => {
            // Prevent Zoom via Keyboard
            window.addEventListener('keydown', e => {
                if (e.ctrlKey && (e.key === '=' || e.key === '-' || e.key === '+' || e.key === '0' || e.key === 'r')) {
                    if (e.key !== 'r') e.preventDefault(); // Allow refresh but block zoom
                }
            });

            // Prevent Zoom via Mouse Wheel
            window.addEventListener('wheel', e => {
                if (e.ctrlKey) e.preventDefault();
            }, { passive: false });

            game.init();
        };
    </script>
</body>
</html>